name: Create and publish Docker images with specific build args

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - dev
    tags:
      - v*

env:
  REGISTRY: ghcr.io

jobs:
  build-image:
    runs-on: ${{ matrix.runner }}
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        include:
          # Main image - linux/amd64
          - platform: linux/amd64
            runner: ubuntu-latest
            variant: ""
            build_args: |
              BUILD_HASH=${{ github.sha }}
            image_suffix: ""
            cache_prefix: ""
          # Main image - linux/arm64
          - platform: linux/arm64
            runner: ubuntu-24.04-arm
            variant: ""
            build_args: |
              BUILD_HASH=${{ github.sha }}
            image_suffix: ""
            cache_prefix: ""
          # CUDA image - linux/amd64
          - platform: linux/amd64
            runner: ubuntu-latest
            variant: cuda
            build_args: |
              BUILD_HASH=${{ github.sha }}
              USE_CUDA=true
            image_suffix: "-cuda"
            cache_prefix: "cache-cuda-"
          # CUDA image - linux/arm64
          - platform: linux/arm64
            runner: ubuntu-24.04-arm
            variant: cuda
            build_args: |
              BUILD_HASH=${{ github.sha }}
              USE_CUDA=true
            image_suffix: "-cuda"
            cache_prefix: "cache-cuda-"
          # CUDA 12.6 image - linux/amd64
          - platform: linux/amd64
            runner: ubuntu-latest
            variant: cuda126
            build_args: |
              BUILD_HASH=${{ github.sha }}
              USE_CUDA=true
              USE_CUDA_VER=cu126
            image_suffix: "-cuda126"
            cache_prefix: "cache-cuda126-"
          # CUDA 12.6 image - linux/arm64
          - platform: linux/arm64
            runner: ubuntu-24.04-arm
            variant: cuda126
            build_args: |
              BUILD_HASH=${{ github.sha }}
              USE_CUDA=true
              USE_CUDA_VER=cu126
            image_suffix: "-cuda126"
            cache_prefix: "cache-cuda126-"
          # Ollama image - linux/amd64
          - platform: linux/amd64
            runner: ubuntu-latest
            variant: ollama
            build_args: |
              BUILD_HASH=${{ github.sha }}
              USE_OLLAMA=true
            image_suffix: "-ollama"
            cache_prefix: "cache-ollama-"
          # Ollama image - linux/arm64
          - platform: linux/arm64
            runner: ubuntu-24.04-arm
            variant: ollama
            build_args: |
              BUILD_HASH=${{ github.sha }}
              USE_OLLAMA=true
            image_suffix: "-ollama"
            cache_prefix: "cache-ollama-"
          # Slim image - linux/amd64
          - platform: linux/amd64
            runner: ubuntu-latest
            variant: slim
            build_args: |
              BUILD_HASH=${{ github.sha }}
              USE_SLIM=true
            image_suffix: "-slim"
            cache_prefix: "cache-slim-"
          # Slim image - linux/arm64
          - platform: linux/arm64
            runner: ubuntu-24.04-arm
            variant: slim
            build_args: |
              BUILD_HASH=${{ github.sha }}
              USE_SLIM=true
            image_suffix: "-slim"
            cache_prefix: "cache-slim-"

    steps:
      - name: Set repository and image name to lowercase
        run: |
          echo "IMAGE_NAME=${IMAGE_NAME,,}" >> $GITHUB_ENV
          echo "FULL_IMAGE_NAME=ghcr.io/${IMAGE_NAME,,}" >> $GITHUB_ENV
        env:
          IMAGE_NAME: '${{ github.repository }}'

      - name: Prepare
        run: |
          platform=${{ matrix.platform }}
          echo "PLATFORM_PAIR=${platform//\//-}" >> $GITHUB_ENV
          echo "VARIANT=${{ matrix.variant }}" >> $GITHUB_ENV

      - name: Delete huge unnecessary tools folder (for CUDA variants)
        if: matrix.variant == 'cuda' || matrix.variant == 'cuda126'
        run: rm -rf /opt/hostedtoolcache

      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker images
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.FULL_IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=tag
            type=sha,prefix=git-
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            ${{ matrix.variant == 'cuda' && 'type=raw,enable=${{ github.ref == "refs/heads/main" }},prefix=,suffix=,value=cuda' || '' }}
            ${{ matrix.variant == 'cuda126' && 'type=raw,enable=${{ github.ref == "refs/heads/main" }},prefix=,suffix=,value=cuda126' || '' }}
            ${{ matrix.variant == 'ollama' && 'type=raw,enable=${{ github.ref == "refs/heads/main" }},prefix=,suffix=,value=ollama' || '' }}
            ${{ matrix.variant == 'slim' && 'type=raw,enable=${{ github.ref == "refs/heads/main" }},prefix=,suffix=,value=slim' || '' }}
          flavor: |
            latest=${{ github.ref == 'refs/heads/main' }}
            ${{ matrix.variant != '' && 'suffix=-' || '' }}${{ matrix.variant }},onlatest=true

      - name: Extract metadata for Docker cache
        id: cache-meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.FULL_IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            ${{ github.ref_type == 'tag' && 'type=raw,value=main' || '' }}
          flavor: |
            prefix=${{ matrix.cache_prefix }}${{ matrix.platform }}-
            latest=false

      - name: Build Docker image
        uses: docker/build-push-action@v5
        id: build
        with:
          context: .
          push: true
          platforms: ${{ matrix.platform }}
          labels: ${{ steps.meta.outputs.labels }}
          outputs: type=image,name=${{ env.FULL_IMAGE_NAME }},push-by-digest=true,name-canonical=true,push=true
          cache-from: type=registry,ref=${{ steps.cache-meta.outputs.tags }}
          cache-to: type=registry,ref=${{ steps.cache-meta.outputs.tags }},mode=max
          build-args: ${{ matrix.build_args }}

      - name: Export digest
        run: |
          mkdir -p /tmp/digests
          digest="${{ steps.build.outputs.digest }}"
          digest_file="${digest#sha256:}"
          echo "$digest" > "/tmp/digests/${digest_file}"
          echo "Digests created for ${{ matrix.platform }}-${{ matrix.variant || 'main' }}"

      - name: Upload digest
        uses: actions/upload-artifact@v4
        with:
          name: digests-${{ matrix.variant || 'main' }}-${{ env.PLATFORM_PAIR }}
          path: /tmp/digests/*
          if-no-files-found: error
          retention-days: 1

  merge-images:
    runs-on: ubuntu-latest
    needs: [build-image]
    strategy:
      fail-fast: false
      matrix:
        include:
          - variant: ""
            artifact_pattern: "digests--*"
          - variant: "cuda"
            artifact_pattern: "digests-cuda-*"
          - variant: "cuda126"
            artifact_pattern: "digests-cuda126-*"
          - variant: "ollama"
            artifact_pattern: "digests-ollama-*"
          - variant: "slim"
            artifact_pattern: "digests-slim-*"

    steps:
      - name: Set repository and image name to lowercase
        run: |
          echo "IMAGE_NAME=${IMAGE_NAME,,}" >> $GITHUB_ENV
          echo "FULL_IMAGE_NAME=ghcr.io/${IMAGE_NAME,,}" >> $GITHUB_ENV
          echo "VARIANT=${{ matrix.variant }}" >> $GITHUB_ENV
        env:
          IMAGE_NAME: '${{ github.repository }}'

      - name: Download digests
        uses: actions/download-artifact@v5
        with:
          pattern: ${{ matrix.artifact_pattern }}
          path: /tmp/digests
          merge-multiple: true

      - name: Verify digests
        run: |
          echo "Digests downloaded"
          ls -la /tmp/digests/
          DIGEST_COUNT=$(ls /tmp/digests/ | wc -l)
          echo "Total digests: $DIGEST_COUNT"
          
          if [ $DIGEST_COUNT -eq 0 ]; then
            echo "Error: No digests found for ${{ matrix.variant || 'main' }} variant"
            exit 1
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker images
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.FULL_IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=tag
            type=sha,prefix=git-
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            ${{ matrix.variant == 'cuda' && 'type=raw,enable=${{ github.ref == "refs/heads/main" }},prefix=,suffix=,value=cuda' || '' }}
            ${{ matrix.variant == 'cuda126' && 'type=raw,enable=${{ github.ref == "refs/heads/main" }},prefix=,suffix=,value=cuda126' || '' }}
            ${{ matrix.variant == 'ollama' && 'type=raw,enable=${{ github.ref == "refs/heads/main" }},prefix=,suffix=,value=ollama' || '' }}
            ${{ matrix.variant == 'slim' && 'type=raw,enable=${{ github.ref == "refs/heads/main" }},prefix=,suffix=,value=slim' || '' }}
          flavor: |
            latest=${{ github.ref == 'refs/heads/main' }}
            ${{ matrix.variant != '' && 'suffix=-' || '' }}${{ matrix.variant }},onlatest=true

      - name: Create manifest list and push
        working-directory: /tmp/digests
        run: |
          echo "Creating manifest for ${{ matrix.variant || 'main' }}"
          
          TAGS_JSON='${{ steps.meta.outputs.json }}'
          TAGS_ARGS=$(echo "$TAGS_JSON" | jq -r '.tags[] | "-t " + .' | tr '\n' ' ')
          
          echo "Tags args: $TAGS_ARGS"
          
          DIGESTS=$(printf '${{ env.FULL_IMAGE_NAME }}@%s ' /tmp/digests/*)
          echo "Digests: $DIGESTS"
          
          docker buildx imagetools create $TAGS_ARGS $DIGESTS

      - name: Inspect image
        run: |
          TAG_NAME=$(echo '${{ steps.meta.outputs.tags }}' | head -1)
          echo "Inspecting image: ${{ env.FULL_IMAGE_NAME }}:$TAG_NAME"
          docker buildx imagetools inspect ${{ env.FULL_IMAGE_NAME }}:$TAG_NAME

  notify:
    runs-on: ubuntu-latest
    needs: [merge-images]
    if: always()
    steps:
      - name: Check job status
        run: |
          echo "All merge jobs completed"
          echo "Status: ${{ needs.merge-images.result }}"
          
          if needs.merge-images.result == 'failure'; then
            echo "Some image builds failed"
            exit 1
          fi

      - name: Summary
        run: |
          echo "## Docker Image Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Main image: ghcr.io/${{ github.repository }}:latest" >> $GITHUB_STEP_SUMMARY
          echo "âœ… CUDA image: ghcr.io/${{ github.repository }}:cuda" >> $GITHUB_STEP_SUMMARY
          echo "âœ… CUDA 12.6 image: ghcr.io/${{ github.repository }}:cuda126" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Ollama image: ghcr.io/${{ github.repository }}:ollama" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Slim image: ghcr.io/${{ github.repository }}:slim" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ Platforms: linux/amd64, linux/arm64" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ·ï¸  Tags generated based on branch and semver" >> $GITHUB_STEP_SUMMARY
